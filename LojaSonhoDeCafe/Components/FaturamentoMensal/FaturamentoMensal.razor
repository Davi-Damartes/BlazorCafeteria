@page "/Faturamento"

@inject IJSRuntime js

@if (MensagemErro is not null)
{
    <ExibirErro MensagemErro="@MensagemErro"></ExibirErro>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th><h1>Faturamento Mensal</h1></th>
                <th> </th>
                <th></th>
            </tr>
            <tr>
                <th>Valor das Vendas do mês de</th>
                <th>Quantidade de Produtos</th>
                <th>Quantidade de Usuarios</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>@TotalPrecoMes</td>
                <td>@TotalQuantProdutos</td>
                <td>@TotalQuantUsuarios</td>
            </tr>
        </tbody>
    </table>

    <h1>Escolha o mês para buscar o Faturamento</h1>
    <div class="select-container">
        <select class="select-box" @bind="mesDoAno">
            <option value="0">Selecione um mês</option>
            @foreach (var mes in mesesDoAno)
            {
                <option value="@mes.Value">@mes.Key</option>
            }
        </select>
        <button class="btn btn-success icone-butao shadow-none" @onclick="(()=> MostrarFaturamento(mesDoAno))">
            Mostrar Faturamento
        </button>
    </div>

    @if (PagamentosDiarios != null && PagamentosDiarios.Any())
    {
        <button type="button" class="btn btn-sm btn-primary botao-Download" @onclick="DownloadTableForExcel">
            <i class="bi bi-download"></i>
            Download Excel
        </button>
    }

    <TabelaFaturamentoMensal PagamentosDiarios="PagamentosDiarios"></TabelaFaturamentoMensal>
}


@code {

    [Inject] IPagamentoService? PagamentoService { get; set; }

    public IEnumerable<PagamentoDiarioDto>? PagamentosDiarios { get; set; }


    private decimal TotalPrecoMes { get; set; }

    private int TotalQuantProdutos { get; set; }

    private int TotalQuantUsuarios { get; set; }

    private int mesDoAno { get; set; }

    public string? NomeDoMes { get; set; }

    private string? MensagemErro { get; set; }


    Dictionary<string, int> mesesDoAno = new Dictionary<string, int>()
    {
        { "Janeiro", 1 },{ "Fevereiro", 2 }, { "Março", 3 },
        { "Abril", 4 },{ "Maio", 5 },  { "Junho", 6 },
        { "Julho", 7 },  { "Agosto", 8 },   { "Setembro", 9 },
        { "Outubro", 10 }, { "Novembro", 11 },{ "Dezembro", 12 }
    };



    private async Task MostrarFaturamento(int mesDoAno)
    {
        try
        {
            NomeDoMes = mesesDoAno.FirstOrDefault(x => x.Value == mesDoAno).Key;
            PagamentosDiarios = await PagamentoService!.ObterTodosPagamentosPorMes(mesDoAno);
            CalcularPrecoTotal();
        }
        catch (Exception ex)
        {
            MensagemErro = $"Erro: {ex.Message}";
        }
    }

    private async Task DownloadTableForExcel( )
    {
        var config = new CsvConfiguration(CultureInfo.InvariantCulture)
            {
                HasHeaderRecord = true
            };
        using (var memoryStream = new MemoryStream())
        using (TextWriter textWriter = new StreamWriter(memoryStream))
        using (var csvWriter = new CsvWriter(textWriter, config))
        {
            await csvWriter.WriteRecordsAsync(PagamentosDiarios);

            textWriter.Flush();
            memoryStream.Seek(0, SeekOrigin.Begin);
            using var streamRef = new DotNetStreamReference(memoryStream);
            string nomeArquivo = $"FaturamentoDe{NomeDoMes}.csv";
            await js.InvokeVoidAsync("downloadFileFromStream", nomeArquivo, streamRef);
        }

    }


    private void CalcularPrecoTotal( )
    {

        GerarValores();
        TotalPrecoMes += PagamentosDiarios!.Sum(x => x.TotalPrecoDiaria);

        TotalQuantProdutos += PagamentosDiarios!.Sum(x => x.TotalQuantDiaria);

        TotalQuantUsuarios += PagamentosDiarios!.Select(x => x.Usuario).Count();
    }

    public void GerarValores( )
    {
        TotalPrecoMes = 0;
        TotalQuantProdutos = 0;
        TotalQuantUsuarios = 0;
    }

}
